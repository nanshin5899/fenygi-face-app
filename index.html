<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>簡易人臉打卡系統</title>
    <style>
        body { font-family: sans-serif; text-align: center; margin: 0; background: #f0f0f0; }
        #video-container { position: relative; margin: 20px auto; width: 320px; height: 240px; background: #000; }
        video { width: 100%; height: 100%; object-fit: cover; }
        canvas { position: absolute; top: 0; left: 0; }
        .controls { margin: 20px; }
        input { padding: 10px; border-radius: 5px; border: 1px solid #ccc; }
        button { padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; }
        button:disabled { background: #ccc; }
        #status { margin-top: 10px; font-weight: bold; color: #333; }
        #log { margin-top: 20px; text-align: left; padding: 10px; background: white; max-width: 300px; margin-left: auto; margin-right: auto; height: 150px; overflow-y: scroll; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
</head>
<body>

    <h2>人臉辨識打卡測試</h2>
    
    <div id="status">正在載入 AI 模型... (請稍候)</div>

    <div id="video-container">
        <video id="video" autoplay muted playsinline></video>
    </div>

    <div class="controls">
        <input type="text" id="nameInput" placeholder="輸入員工姓名">
        <button id="registerBtn" onclick="registerFace()" disabled>註冊這張臉</button>
    </div>

    <h3>打卡紀錄：</h3>
    <div id="log"></div>

    <script>
        const video = document.getElementById('video');
        const status = document.getElementById('status');
        const registerBtn = document.getElementById('registerBtn');
        const logDiv = document.getElementById('log');
        
        let labeledDescriptors = []; // 存儲註冊的人臉數據
        let faceMatcher; // 比對器

        // 1. 載入模型 (使用公開的 GitHub 資源，免下載)
        Promise.all([
            faceapi.nets.tinyFaceDetector.loadFromUri('https://justadudewhohacks.github.io/face-api.js/models'),
            faceapi.nets.faceLandmark68Net.loadFromUri('https://justadudewhohacks.github.io/face-api.js/models'),
            faceapi.nets.faceRecognitionNet.loadFromUri('https://justadudewhohacks.github.io/face-api.js/models')
        ]).then(startVideo).catch(err => {
            status.innerText = "模型載入失敗，請檢查網路";
            console.error(err);
        });

        // 2. 啟動攝影機
        function startVideo() {
            status.innerText = "正在啟動攝影機...";
            navigator.mediaDevices.getUserMedia({ video: {} })
                .then(stream => {
                    video.srcObject = stream;
                    status.innerText = "系統就緒！請輸入姓名並註冊";
                    registerBtn.disabled = false;
                    startRecognition(); // 開始偵測迴圈
                })
                .catch(err => {
                    status.innerText = "無法開啟攝影機 (請確認 HTTPS 或權限)";
                    console.error(err);
                });
        }

        // 3. 註冊人臉功能
        async function registerFace() {
            const name = document.getElementById('nameInput').value;
            if (!name) { alert("請先輸入姓名！"); return; }

            status.innerText = "正在註冊...";
            
            // 偵測目前畫面中的單一人臉
            const detection = await faceapi.detectSingleFace(video, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks().withFaceDescriptor();

            if (detection) {
                // 將特徵數據存入陣列
                labeledDescriptors.push(new faceapi.LabeledFaceDescriptors(name, [detection.descriptor]));
                
                // 更新比對器
                faceMatcher = new faceapi.FaceMatcher(labeledDescriptors, 0.6);
                
                status.innerText = `成功註冊：${name}`;
                alert(`已記住 ${name} 的臉！`);
                document.getElementById('nameInput').value = '';
            } else {
                alert("沒抓到臉，請正對鏡頭再試一次");
                status.innerText = "註冊失敗";
            }
        }

        // 4. 即時辨識迴圈
        async function startRecognition() {
            const canvas = faceapi.createCanvasFromMedia(video);
            document.getElementById('video-container').append(canvas);
            const displaySize = { width: video.width || 320, height: video.height || 240 };
            faceapi.matchDimensions(canvas, displaySize);

            setInterval(async () => {
                // 如果還沒註冊任何人，就不辨識
                if (!faceMatcher) return;

                // 偵測畫面中所有的人臉
                const detections = await faceapi.detectAllFaces(video, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks().withFaceDescriptors();
                const resizedDetections = faceapi.resizeResults(detections, displaySize);

                // 清除舊的繪圖
                canvas.getContext('2d').clearRect(0, 0, canvas.width, canvas.height);

                // 比對每一張臉
                const results = resizedDetections.map(d => faceMatcher.findBestMatch(d.descriptor));

                results.forEach((result, i) => {
                    const box = resizedDetections[i].detection.box;
                    const drawBox = new faceapi.draw.DrawBox(box, { label: result.toString() });
                    drawBox.draw(canvas);

                    // 如果辨識出已知的人 (不是 unknown)，就記錄
                    if (result.label !== 'unknown') {
                        addLog(result.label);
                    }
                });
            }, 500); // 每 0.5 秒偵測一次
        }

        // 簡單的防止重複打卡機制 (5秒內不重複記)
        let lastLogTime = 0;
        let lastLogName = "";

        function addLog(name) {
            const now = new Date();
            if (name === lastLogName && (now - lastLogTime) < 5000) return; // 5秒內同一個人不重複顯示

            lastLogTime = now;
            lastLogName = name;
            
            const timeString = now.toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.innerText = `[${timeString}] ${name} 已通過`;
            logDiv.prepend(logEntry); // 最新紀錄在最上面
            status.innerText = `歡迎！ ${name}`;
        }
    </script>
</body>
</html>